# Глобальные настройки
global
    log stdout format raw local0
    maxconn 4096
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options no-sslv3 no-tls-tickets

defaults
    mode http
    log global
    option httplog
    option dontlognull
    timeout connect 10s
    timeout client 60s
    timeout server 60s
    option forwardfor

# -----------------------------
# FRONTEND для Nextcloud + AppAPI
# -----------------------------
frontend nextcloud_front
    bind *:80
    bind *:443 ssl crt /etc/letsencrypt/live/{{ domain }}/fullchain.pem \
                     crt /etc/letsencrypt/live/{{ domain }}/privkey.pem
    mode http

    # Все HTTP -> HTTPS редирект
    redirect scheme https if !{ ssl_fc }

    # ACL для AppAPI по хосту
    {% for app in appapi_apps %}
    acl is_{{ app.name }} hdr(host) -i {{ app.name }}.{{ domain }}
    use_backend {{ app.name }}_backend if is_{{ app.name }}
    {% endfor %}

    # По умолчанию Nextcloud
    default_backend nextcloud_backend

# -----------------------------
# BACKEND для Nextcloud
# -----------------------------
backend nextcloud_backend
    mode http
    balance roundrobin
    option httpchk GET /status.php
    server nextcloud nextcloud:80 check inter 5s fall 3 rise 2

# -----------------------------
# BACKENDS для AppAPI приложений
# -----------------------------
{% for app in appapi_apps %}
backend {{ app.name }}_backend
    mode http
    balance roundrobin
    option httpchk GET {{ app.healthcheck_path | default('/') }}
    {% for server in app.servers %}
    server {{ server.name }} {{ server.address }} check inter 5s fall 3 rise 2
    {% endfor %}
{% endfor %}
