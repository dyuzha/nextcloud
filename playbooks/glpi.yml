---
- name: "üöÄ GLPI"
  hosts: glpi
  become: true
  gather_facts: true

  roles:
    - glpi

  tasks:
    - name: "1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤"
      apt:
        name:
          - docker.io
          - docker-compose-plugin
          - python3-pip
          - python3-docker
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: "2. –ó–∞–ø—É—Å–∫ Docker —Å–µ—Ä–≤–∏—Å–∞"
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: "3. –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è GLPI"
      file:
        path: /opt/glpi
        state: directory
        mode: '0755'

    - name: "4. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ docker-compose.yml –∏–∑ —à–∞–±–ª–æ–Ω–∞"
      template:
        src: ../files/docker-compose.yml.j2
        dest: /opt/glpi/docker-compose.yml
        mode: '0644'

    - name: "5. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –∏–∑ —à–∞–±–ª–æ–Ω–∞"
      template:
        src: ../files/.env.j2
        dest: /opt/glpi/.env
        mode: '0600'

    - name: "6. –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤"
      community.docker.docker_compose_v2:
        project_src: /opt/glpi
        state: present
        pull: always
        remove_orphans: yes
      register: compose_output

    - name: "7. –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ GLPI (—á–µ—Ä–µ–∑ CLI)"
      ansible.builtin.command:
        cmd: docker exec glpi-glpi-1 php bin/console system:status --format json
      register: glpi_status
      retries: 12
      delay: 10
      until: glpi_status.rc == 0
      ignore_errors: yes

    - name: "8. –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–∏"
      debug:
        msg:
          - "‚úÖ GLPI —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç!"
          - "üåê –ê–¥—Ä–µ—Å: http://{{ ansible_default_ipv4.address }}"
          - "üîë –õ–æ–≥–∏–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: glpi / glpi"
